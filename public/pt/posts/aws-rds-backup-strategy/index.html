<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.81.0" />

    
    
    

<title>AWS RDS Backup Strategy • krismorte</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AWS RDS Backup Strategy"/>
<meta name="twitter:description" content="Esse post vai tratar de uma estratégia de backup e disaster recovery voltado ao AWS RDS feito através de lambdas. Primeiramente vamos falar sobre as snapshots que vem habilitadas por default no RDS é uma solução ao me ver bem robusta com a opção de point-in-time que realiza backups de logs a cada 5 minutos o que permite uma cobertura enorme em casos de falhas. Existem 2 tipos de snapshot automática e manual, as automáticas são feitas diariamente e incrementais durante o decorrer do dia para fornecer o point-in-time elas são mantidas por no máximo 35 dias, e isso não é configurável, já as manuais são feitas por console, cli ou aplicações e não tem data de validade e são limitadas a 100 por instância e região mais esse número pode ser incrementados via chamado com a AWS."/>

<meta property="og:title" content="AWS RDS Backup Strategy" />
<meta property="og:description" content="Esse post vai tratar de uma estratégia de backup e disaster recovery voltado ao AWS RDS feito através de lambdas. Primeiramente vamos falar sobre as snapshots que vem habilitadas por default no RDS é uma solução ao me ver bem robusta com a opção de point-in-time que realiza backups de logs a cada 5 minutos o que permite uma cobertura enorme em casos de falhas. Existem 2 tipos de snapshot automática e manual, as automáticas são feitas diariamente e incrementais durante o decorrer do dia para fornecer o point-in-time elas são mantidas por no máximo 35 dias, e isso não é configurável, já as manuais são feitas por console, cli ou aplicações e não tem data de validade e são limitadas a 100 por instância e região mais esse número pode ser incrementados via chamado com a AWS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://krismorte.github.io/pt/posts/aws-rds-backup-strategy/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-13T18:55:33&#43;00:00" />
<meta property="article:modified_time" content="2020-04-13T18:55:33&#43;00:00" />



    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.71157e768c4e111a23c3531b95e0cbb59bbef3c9e6901d36247cb53d6b6be258.css" integrity="sha256-cRV&#43;doxOERojw1MbleDLtZu&#43;88nmkB02JHy1PWtr4lg=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

<link href="https://krismorte.github.io/css/custom.css" rel="stylesheet">
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://krismorte.github.io">
        
          krismorte
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://krismorte.github.ioimg/pulguenta.png" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Krisnamourt da Silva C. Filho 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">krismorte</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/career/">
						<span>Carreira</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>Sobre</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>Tags</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/krismorte" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://github.com/krismorte" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	<a href="https://instagram.com/krismorte" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/krisnamourt-filho" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://stackoverflow.com/users/4722804/krismorte" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2021 htr3n
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>AWS RDS Backup Strategy</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Apr 13, 2020
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/java">java</a>
           
      
          <a class="badge badge-tag" href="/tags/database">database</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 7 min read
</div>


  </header>
  
  
  <div class="post">
    <p>Esse post vai tratar de uma estratégia de backup e disaster recovery voltado ao AWS RDS feito através de lambdas. Primeiramente vamos falar sobre as snapshots que vem habilitadas por default no RDS é uma solução ao me ver bem robusta com a opção de point-in-time que realiza backups de logs a cada 5 minutos o que permite uma cobertura enorme em casos de falhas. Existem 2 tipos de snapshot automática e manual, as automáticas são feitas diariamente e incrementais durante o decorrer do dia para fornecer o point-in-time elas são mantidas por no máximo 35 dias, e isso não é configurável, já as manuais são feitas por console, cli ou aplicações e não tem data de validade e são limitadas a 100 por instância e região mais esse número pode ser incrementados via chamado com a AWS. Um detalhe importante aqui é a possibilidade de você copiar essas snapshot tanto manual como automática sendo que toda snapshot automática copiada se tornar manual, essa será nossa estrategia aqui.</p>
<p>Dependendo do seu negócio e das implicações legais você terá de manter cópias de dados por um determinado tempo. Nesse caso automatizar cópias dos backups já feitos para que se tornem manuais é bem útil, porém é interessante por um limite (em dias) para manter essas snapshots. Por isso temos 2 pares de lambdas uma para a realização do backup e outra pra remoção.
Se tratando do disaster recovery aqui não será apresentada uma solução 100% automatiza com o menor tempo de downtime, mas a função mais básica que é ter backups e cópias desses backups em outras regiões em caso de falha da região principal. Mais uma vez através de lambdas nesse caso recomendo manter essas snapshopts por pelo menos uma semana. Lembrando que aqui estamos tratando somente de snapshot de RDS, sua aplicação deve ser também copiada para a nova região e caso queira retornar para a região original todos os passos deverão ser repetidos no sentido contrário.</p>
<p>Depois dessa breve explicação vamos ao código, apesar de ser DBA ainda não domino python então vamos de javascript  ferramentas necessárias serão AWS CLI configurada, nodejs &gt;=10 com o <a href="https://www.serverless.com/">serverless framework</a> instalado esse framework é usado pro deploy na AWS. Versão completa do código está no <a href="https://github.com/krismorte/lambda-rds-snapshot">github</a></p>
<p>A SDK da AWS é imensa, então separei apenas as funções que preciso nas minhas aplicações em um único arquivo <code>rds-func.js</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">defaultTag</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ClonedBy&#39;</span>,
    <span style="color:#a6e22e">Value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Lambda&#39;</span>
  }
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">regionTag</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;SourceRegion&#39;</span>,<span style="color:#a6e22e">Value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RDSFunc</span>{
  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">AWS</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">RDS</span>();
  }

  <span style="color:#a6e22e">describeClusters</span>(){
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">clusters</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBClusters</span>({}).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBClusters</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">clusters</span>;
  }

  <span style="color:#a6e22e">describeInstances</span>(){
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">instances</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBInstances</span>({}).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBInstances</span>
    })
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">instances</span>;
  }

  <span style="color:#a6e22e">describeClustersAutomatedSnapshot</span>(<span style="color:#a6e22e">cluster</span>){

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">DBClusterIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cluster</span>,
      <span style="color:#a6e22e">SnapshotType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;automated&#34;</span>,
      <span style="color:#a6e22e">MaxRecords</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBClusterSnapshots</span>(<span style="color:#a6e22e">params</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBClusterSnapshots</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snaps</span>;
  }

  <span style="color:#a6e22e">describeClustersManualSnapshot</span>(<span style="color:#a6e22e">cluster</span>){

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">DBClusterIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cluster</span>,
      <span style="color:#a6e22e">SnapshotType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;manual&#34;</span>,
      <span style="color:#a6e22e">MaxRecords</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBClusterSnapshots</span>(<span style="color:#a6e22e">params</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBClusterSnapshots</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snaps</span>;
  }

  <span style="color:#a6e22e">describeInstanceAutomatedSnapshot</span>(<span style="color:#a6e22e">instance</span>){

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">DBInstanceIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instance</span>,
      <span style="color:#a6e22e">SnapshotType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;automated&#34;</span>,
      <span style="color:#a6e22e">MaxRecords</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBSnapshots</span>(<span style="color:#a6e22e">params</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBSnapshots</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snaps</span>;
  }

  <span style="color:#a6e22e">describeInstanceManualSnapshot</span>(<span style="color:#a6e22e">instance</span>){

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">DBInstanceIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instance</span>,
      <span style="color:#a6e22e">SnapshotType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;manual&#34;</span>,
      <span style="color:#a6e22e">MaxRecords</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBSnapshots</span>(<span style="color:#a6e22e">params</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBSnapshots</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snaps</span>;
  }

  <span style="color:#a6e22e">copyClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>,<span style="color:#a6e22e">region</span>){
    
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">paramClone</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">SourceDBClusterSnapshotIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">snap</span>,
      <span style="color:#a6e22e">TargetDBClusterSnapshotIdentifier</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">renameSnapshot</span>(<span style="color:#a6e22e">snap</span>),
      <span style="color:#a6e22e">Tags</span><span style="color:#f92672">:</span> [
        <span style="color:#a6e22e">defaultTag</span>,
      ]
    };
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">region</span>){
      <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">SourceRegion</span><span style="color:#f92672">=</span><span style="color:#a6e22e">region</span>
      <span style="color:#a6e22e">regionTag</span>.<span style="color:#a6e22e">Value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">region</span>
      <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">Tags</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">regionTag</span>)
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">newSnapName</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">copyDBClusterSnapshot</span>(<span style="color:#a6e22e">paramClone</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">TargetDBClusterSnapshotIdentifier</span>
    });
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSnapName</span>
  }

  <span style="color:#a6e22e">copyInstanceSnapshot</span>(<span style="color:#a6e22e">snap</span>,<span style="color:#a6e22e">region</span>){
    
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">paramClone</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">SourceDBSnapshotIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">snap</span>,
      <span style="color:#a6e22e">TargetDBSnapshotIdentifier</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">renameSnapshot</span>(<span style="color:#a6e22e">snap</span>),
      <span style="color:#a6e22e">Tags</span><span style="color:#f92672">:</span> [
        <span style="color:#a6e22e">defaultTag</span>,
      ]
    };
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">region</span>){
      <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">SourceRegion</span><span style="color:#f92672">=</span><span style="color:#a6e22e">region</span>
      <span style="color:#a6e22e">regionTag</span>.<span style="color:#a6e22e">Value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">region</span>
      <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">Tags</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">regionTag</span>)
    }
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">paramClone</span>)

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">newSnapName</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">copyDBSnapshot</span>(<span style="color:#a6e22e">paramClone</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">TargetDBSnapshotIdentifier</span>
    });
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSnapName</span>
  }

  <span style="color:#a6e22e">deleteClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">deleteDBClusterSnapshot</span>({<span style="color:#a6e22e">DBClusterSnapshotIdentifier</span><span style="color:#f92672">:</span><span style="color:#a6e22e">snap</span>}).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
    });
  }

  <span style="color:#a6e22e">deleteInstanceSnapshot</span>(<span style="color:#a6e22e">snap</span>){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">deleteDBSnapshot</span>({<span style="color:#a6e22e">DBSnapshotIdentifier</span><span style="color:#f92672">:</span><span style="color:#a6e22e">snap</span>}).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
    });
  }

  <span style="color:#a6e22e">renameSnapshot</span>(<span style="color:#a6e22e">snapName</span>){
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#e6db74">&#39;arn:&#39;</span>)){
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#34;snapshot:rds&#34;</span>);
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tmpName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">substring</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">length</span>)
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tmpName</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;snapshot:&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#34;rds:&#34;</span>, <span style="color:#e6db74">&#34;manual-&#34;</span>);
    }<span style="color:#66d9ef">else</span>{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#34;rds:&#34;</span>, <span style="color:#e6db74">&#34;manual-&#34;</span>)
    }
  }

}


<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">RDSFunc</span>
}
</code></pre></div><p>Primeiro detalhe que salta aos olhos é que cluster e intâncias são tratados por chamadas diferentes na SDK assim como suas respectivas snapshots</p>
<blockquote>
<blockquote>
<p>describeDBClusters
describeDBInstances
describeDBClusterSnapshots
describeDBSnapshots</p>
</blockquote>
</blockquote>
<p>Outro detalhe é que para buscar as snapshots é obrigatório saber o nome do recurso (cluster ou instância), por isso em todos os lambdas foi necessário listar os recursos tanto para copiar as snapshots quanto para removê-las.</p>
<p>No trecho abaixo temos o backup diário onde são listados os cluster, verificado a data a partir de uma função que recebe quantos dias a partir de hoje serão removidos e logo depois é feita a chamada de cópia. Como todas as chamadas são assícronas depois que o lambda for executado você poderá acompanhar a criação da snapshot pelo console, dependendo do tamanho do server isso pode ser bem rápido. Logo depois o mesmo processo é repetido para instâncias.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cluster</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClusters</span>();

    <span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">cluster</span>)=&gt;{
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClustersAutomatedSnapshot</span>(<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">DBClusterIdentifier</span>)
        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snaps</span>){
          <span style="color:#a6e22e">snaps</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">snap</span>)=&gt;{
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">minusDaysFromToday</span>(<span style="color:#a6e22e">daysBefore</span>);
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snapshotDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">removeTimeFromDate</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">SnapshotCreateTime</span>);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">snapshotDate</span>) {
                <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">copyClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">DBClusterSnapshotIdentifier</span>)
                <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">copy</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; Rds cluster snapshot cloned&#34;</span>)
            }
        })
        }        
    })

<span style="color:#75715e">//RDS Instance
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">instances</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeInstances</span>();
    <span style="color:#a6e22e">instances</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">instance</span>)=&gt;{
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeInstanceAutomatedSnapshot</span>(<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">DBInstanceIdentifier</span>)
      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snaps</span>){
        <span style="color:#a6e22e">snaps</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">snap</span>)=&gt;{
          <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">minusDaysFromToday</span>(<span style="color:#a6e22e">daysBefore</span>);
          <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snapshotDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">removeTimeFromDate</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">SnapshotCreateTime</span>);
          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">snapshotDate</span>) {
              <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">copyInstanceSnapshot</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">DBSnapshotIdentifier</span>)
              <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">copy</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; Rds instance snapshot cloned&#34;</span>)
          }
        })
      }      
    })
</code></pre></div><p>A remoção segue a mesma lógica trocando a chamada de cópia pela de remoção</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cluster</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClusters</span>();

    <span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">cluster</span>)=&gt;{
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClustersManualSnapshot</span>(<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">DBClusterIdentifier</span>)
        
        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snaps</span>){
          <span style="color:#a6e22e">snaps</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">snap</span>)=&gt;{
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">minusDaysFromToday</span>(<span style="color:#a6e22e">daysBefore</span>);
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snapshotDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">removeTimeFromDate</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">SnapshotCreateTime</span>);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">snapshotDate</span>) {
                <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">deleteClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">DBClusterSnapshotIdentifier</span>)
                <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">copy</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; Rds cluster snapshot deleted&#34;</span>)
            }
        })
        }        
    })
</code></pre></div><p>Na função que faz a copia para outra região entra um detalhe interessante, as buscas  são realizadas a partir da região original, mas o pedido de cópia deve ser feito da região de destino mas obrigatoriamente informado a região de origem, outro detalhe é que aqui a snapshot será referenciada pelo ARN e não pelo nome.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cluster</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClusters</span>();

<span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">length</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClustersAutomatedSnapshot</span>(<span style="color:#a6e22e">cluster</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">DBClusterIdentifier</span>)
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snaps</span>){
        <span style="color:#a6e22e">snaps</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">snap</span>)=&gt;{
            <span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">update</span>({
                <span style="color:#a6e22e">region</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">copyRegion</span>
            })
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rdsFuncOtherRegion</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RDSFunc</span>(<span style="color:#a6e22e">AWS</span>)
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">minusDaysFromToday</span>(<span style="color:#a6e22e">daysBefore</span>);
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snapshotDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">removeTimeFromDate</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">SnapshotCreateTime</span>);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">snapshotDate</span>) {
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFuncOtherRegion</span>.<span style="color:#a6e22e">copyClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">DBClusterSnapshotArn</span>,<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">mainRegion</span>)
            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">copy</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; Rds cluster snapshot cloned&#34;</span>)
            }
        })
     }        
}
</code></pre></div><p>No lambda delete a lógica é a mesma onde é trocada a chamada de cópia pela de remoção e a snapshot volta a ser referênciada pelo nome.</p>
<p>Veja que dentro das funções toda a parametrização vem por meio de env todas são declaradas no arquivo principal <code>serverless.yml</code> usado pelo framework. No trecho abaixo informamos o provider a região onde iremos deployar o profile configurado para o seu aws cli, uma IAM com poderes full sobre os RDS (você pode alterar por uma mais limitado) e as variáveis.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">provider</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">aws</span>
  <span style="color:#f92672">runtime</span>: <span style="color:#ae81ff">nodejs10.x</span>
  <span style="color:#f92672">region</span>: <span style="color:#ae81ff">us-west-2</span>
  <span style="color:#f92672">profile</span>: <span style="color:#ae81ff">&lt;YOUR-AWS-PROFILE&gt;</span>
  <span style="color:#f92672">iamManagedPolicies</span>:
    - <span style="color:#e6db74">&#34;arn:aws:iam::aws:policy/AmazonRDSFullAccess&#34;</span>
  <span style="color:#f92672">environment</span>:
    <span style="color:#f92672">daysBefore</span>: <span style="color:#ae81ff">30</span>
    <span style="color:#f92672">keepDays</span>: <span style="color:#ae81ff">6</span>
    <span style="color:#f92672">keepLongDays</span>: <span style="color:#ae81ff">365</span>
    <span style="color:#f92672">mainRegion</span>: <span style="color:#ae81ff">us-west-2</span>
    <span style="color:#f92672">copyRegion</span>: <span style="color:#ae81ff">us-east-2</span>
</code></pre></div><p><strong>daysBefore:</strong> <em>diz respeito a quantidades de dias para a busca de backups automaticos e torna-los manual, você pode tornar esse valor zero para pegare sempre o mais atual, mas lembre-se que as snapshot são incrementais então dependendo do horário a snapshot poderá nçao estar completa.</em>
<strong>keepDays &amp; keepLongDays:</strong> <em>são referentes a quantos dias as snapshot devem ser mantidas a primeira se refere as snapshot em outra região e segunda na mesma região</em></p>
<p><strong>mainRegion &amp; copyRegion:</strong> <em>as duas últimas se referem a regiões onde os RDS estão e a região secundária visando o disaster recovery</em></p>
<p>O empacotamento pode ser customizado nesse caso eu apenas o utilo para exluir alguns arquivos</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">package</span>:
  <span style="color:#f92672">exclude</span>:
    - <span style="color:#ae81ff">README.md</span>
    - <span style="color:#ae81ff">.gitignore</span>
    - <span style="color:#ae81ff">.vscode</span>
    - <span style="color:#ae81ff">node_modules</span>
    - <span style="color:#ae81ff">__test__</span>
</code></pre></div><p>Nesse trecho as funções propriamente ditas onde declaro nome, arquivo + function, um timeout e o evento disparador que nesse caso é um agendamento cron. Eu prefiro essa abordagem de declarar e deployar todas as funções de uma vez, porém caso queria é possivel deployar uma por vez como será visto abaixo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">functions</span>:
  <span style="color:#f92672">manual-backup</span>:
    <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">rds-clone-snap.main</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">events</span>:
      - <span style="color:#f92672">schedule</span>: <span style="color:#ae81ff">cron(0 10 1/1 * ? *)</span>
  <span style="color:#f92672">manual-backup-other-region</span>:
    <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">rds-clone-snap-region.main</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">events</span>:
      - <span style="color:#f92672">schedule</span>: <span style="color:#ae81ff">cron(0 10 1/1 * ? *)</span>
  <span style="color:#f92672">delete-backup</span>:
    <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">rds-del-snap.main</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">events</span>:
      - <span style="color:#f92672">schedule</span>: <span style="color:#ae81ff">cron(0 10 1/1 * ? *)</span>
  <span style="color:#f92672">delete-backup-other-region</span>:
    <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">rds-del-snap-region.main</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">events</span>:
      - <span style="color:#f92672">schedule</span>: <span style="color:#ae81ff">cron(0 10 1/1 * ? *)</span>
</code></pre></div><p>Pronto tudo feito agora nos resta de fato manda-las pra nuvem. Basta usar a linha de comando pra isso</p>
<p><code>serverless deploy</code></p>
<p>ou por função</p>
<p><code>serverless deploy function --function manual-backup</code></p>
<p>Pra remover</p>
<p><code>serverless remove</code></p>
<p>Aqui podemos dizer que poderemos dormir mais tranquilamente sabendo que nossos RDS estão protegidosde eventuais falhas. O básico das snapshots e disponibilidades em outras regiões ficam cobertas aqui, óbvio que uma solução de disaster recovery do seu ambiente será mais compliado e envolverá mais tecnologias e outras formas de automação.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/pt/posts/documenting-databases-with-schemaspy/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Documentando bancos com Schemaspy</span>
    </a>
    
    
    <a href="/pt/posts/managing-github-terraform/" class="navigation-next">
      <span class="navigation-tittle">Gerenciando seu github com Terraform</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>

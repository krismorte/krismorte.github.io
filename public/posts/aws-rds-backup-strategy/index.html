<!DOCTYPE html>
<html lang="">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.81.0" />

    
    
    

<title>AWS RDS Backup Strategy • krismorte</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AWS RDS Backup Strategy"/>
<meta name="twitter:description" content="This post will talk about backup and disaster recovery strategy on AWS RDS been mande by lambdas. First of all let&rsquo;s talk about the default snapshot that comes enable on every RDS and from my sight is a really good solution with its point-in-time option that takes log backups each every 5 minutes which allow us huge coverage on failures. There&rsquo;s 2 types of snapshot automated and manual, automated are taken daily and incremented all day long to delivery the point-in-time solution these snapshot are holding for 35 days max, and this isn&rsquo;t configurable, the manual are made manually, throuth the CLI or by application and there&rsquo;s no expire date and are limited to 100 per instance and region but you can increase this number opening a support ticket with AWS."/>

<meta property="og:title" content="AWS RDS Backup Strategy" />
<meta property="og:description" content="This post will talk about backup and disaster recovery strategy on AWS RDS been mande by lambdas. First of all let&rsquo;s talk about the default snapshot that comes enable on every RDS and from my sight is a really good solution with its point-in-time option that takes log backups each every 5 minutes which allow us huge coverage on failures. There&rsquo;s 2 types of snapshot automated and manual, automated are taken daily and incremented all day long to delivery the point-in-time solution these snapshot are holding for 35 days max, and this isn&rsquo;t configurable, the manual are made manually, throuth the CLI or by application and there&rsquo;s no expire date and are limited to 100 per instance and region but you can increase this number opening a support ticket with AWS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://krismorte.github.io/posts/aws-rds-backup-strategy/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-13T18:55:33&#43;00:00" />
<meta property="article:modified_time" content="2020-04-13T18:55:33&#43;00:00" />



    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.71157e768c4e111a23c3531b95e0cbb59bbef3c9e6901d36247cb53d6b6be258.css" integrity="sha256-cRV&#43;doxOERojw1MbleDLtZu&#43;88nmkB02JHy1PWtr4lg=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://krismorte.github.io">
        
          krismorte
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://krismorte.github.ioimg/pulguenta.png" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         Krisnamourt da Silva C. Filho 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">krismorte</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/career/">
						<span>Career</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>Tags</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/krismorte" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://github.com/krismorte" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	<a href="https://instagram.com/krismorte" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/krisnamourt-filho" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://stackoverflow.com/users/4722804/krismorte" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2021 htr3n
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>AWS RDS Backup Strategy</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Apr 13, 2020
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/java">java</a>
           
      
          <a class="badge badge-tag" href="/tags/database">database</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 7 min read
</div>


  </header>
  
  
  <div class="post">
    <p>This post will talk about backup and disaster recovery strategy on AWS RDS been mande by lambdas. First of all let&rsquo;s talk about the default snapshot that comes enable on every RDS and from my sight is a really good solution with its point-in-time option that takes log backups each every 5 minutes which allow us huge coverage on failures. There&rsquo;s 2 types of snapshot automated and manual, automated are taken daily and  incremented all day long to delivery the point-in-time solution these snapshot are holding for 35 days max, and this isn&rsquo;t configurable, the manual are made manually, throuth the CLI or by application and there&rsquo;s no expire date and are limited to 100 per instance and region but you can increase this number opening a support ticket with AWS. An important detail here is the possibility to take copy of these snapshots for both but from automated the result always became a manual, and this will be our strategy today.</p>
<p>Depending on which is you business and legal implications you have to keep copies for you data for amount of time. In this case automated copies from the existing backups is pretty handful, although is interesting put a a limit date to keep all these backups. For this reason we have 2 pair for lambda one for made the backup and another to remove it. When is comes to disaster recovery I won&rsquo;t present a full action automated plan to take a minimum downtime possible today, instead will show the base action of do the backups and copy in a different region in case of failure of the main one. Remind yourself that we are taking care only of your RDS snapshot for now, to a full disaster recovery your application has to be copied as well as all the dependencies, and if you want to come backup to the main region all the steps until now have to made in the opposite direction.</p>
<p>After this brief explanation let go to the code, although I&rsquo;m a DBA still have to dominate python so this time will be javascript other tools would be AWS CLI configured, nodejs &gt;=10 with <a href="https://www.serverless.com/">serverless framework</a> installed , this framework is used to deploy on AWS. Full version of this code is on <a href="https://github.com/krismorte/lambda-rds-snapshot">github</a></p>
<p>AWS SDK is huge so I got just the function I need on the applications in a single file <code>rds-func.js</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">defaultTag</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ClonedBy&#39;</span>,
    <span style="color:#a6e22e">Value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Lambda&#39;</span>
  }
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">regionTag</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;SourceRegion&#39;</span>,<span style="color:#a6e22e">Value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RDSFunc</span>{
  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">AWS</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">RDS</span>();
  }

  <span style="color:#a6e22e">describeClusters</span>(){
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">clusters</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBClusters</span>({}).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBClusters</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">clusters</span>;
  }

  <span style="color:#a6e22e">describeInstances</span>(){
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">instances</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBInstances</span>({}).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBInstances</span>
    })
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">instances</span>;
  }

  <span style="color:#a6e22e">describeClustersAutomatedSnapshot</span>(<span style="color:#a6e22e">cluster</span>){

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">DBClusterIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cluster</span>,
      <span style="color:#a6e22e">SnapshotType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;automated&#34;</span>,
      <span style="color:#a6e22e">MaxRecords</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBClusterSnapshots</span>(<span style="color:#a6e22e">params</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBClusterSnapshots</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snaps</span>;
  }

  <span style="color:#a6e22e">describeClustersManualSnapshot</span>(<span style="color:#a6e22e">cluster</span>){

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">DBClusterIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cluster</span>,
      <span style="color:#a6e22e">SnapshotType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;manual&#34;</span>,
      <span style="color:#a6e22e">MaxRecords</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBClusterSnapshots</span>(<span style="color:#a6e22e">params</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBClusterSnapshots</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snaps</span>;
  }

  <span style="color:#a6e22e">describeInstanceAutomatedSnapshot</span>(<span style="color:#a6e22e">instance</span>){

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">DBInstanceIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instance</span>,
      <span style="color:#a6e22e">SnapshotType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;automated&#34;</span>,
      <span style="color:#a6e22e">MaxRecords</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBSnapshots</span>(<span style="color:#a6e22e">params</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBSnapshots</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snaps</span>;
  }

  <span style="color:#a6e22e">describeInstanceManualSnapshot</span>(<span style="color:#a6e22e">instance</span>){

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">DBInstanceIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instance</span>,
      <span style="color:#a6e22e">SnapshotType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;manual&#34;</span>,
      <span style="color:#a6e22e">MaxRecords</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">describeDBSnapshots</span>(<span style="color:#a6e22e">params</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">DBSnapshots</span>;
    })    
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snaps</span>;
  }

  <span style="color:#a6e22e">copyClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>,<span style="color:#a6e22e">region</span>){
    
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">paramClone</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">SourceDBClusterSnapshotIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">snap</span>,
      <span style="color:#a6e22e">TargetDBClusterSnapshotIdentifier</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">renameSnapshot</span>(<span style="color:#a6e22e">snap</span>),
      <span style="color:#a6e22e">Tags</span><span style="color:#f92672">:</span> [
        <span style="color:#a6e22e">defaultTag</span>,
      ]
    };
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">region</span>){
      <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">SourceRegion</span><span style="color:#f92672">=</span><span style="color:#a6e22e">region</span>
      <span style="color:#a6e22e">regionTag</span>.<span style="color:#a6e22e">Value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">region</span>
      <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">Tags</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">regionTag</span>)
    }

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">newSnapName</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">copyDBClusterSnapshot</span>(<span style="color:#a6e22e">paramClone</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">TargetDBClusterSnapshotIdentifier</span>
    });
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSnapName</span>
  }

  <span style="color:#a6e22e">copyInstanceSnapshot</span>(<span style="color:#a6e22e">snap</span>,<span style="color:#a6e22e">region</span>){
    
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">paramClone</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">SourceDBSnapshotIdentifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">snap</span>,
      <span style="color:#a6e22e">TargetDBSnapshotIdentifier</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">renameSnapshot</span>(<span style="color:#a6e22e">snap</span>),
      <span style="color:#a6e22e">Tags</span><span style="color:#f92672">:</span> [
        <span style="color:#a6e22e">defaultTag</span>,
      ]
    };
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">region</span>){
      <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">SourceRegion</span><span style="color:#f92672">=</span><span style="color:#a6e22e">region</span>
      <span style="color:#a6e22e">regionTag</span>.<span style="color:#a6e22e">Value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">region</span>
      <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">Tags</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">regionTag</span>)
    }
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">paramClone</span>)

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">newSnapName</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">copyDBSnapshot</span>(<span style="color:#a6e22e">paramClone</span>).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">paramClone</span>.<span style="color:#a6e22e">TargetDBSnapshotIdentifier</span>
    });
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newSnapName</span>
  }

  <span style="color:#a6e22e">deleteClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">deleteDBClusterSnapshot</span>({<span style="color:#a6e22e">DBClusterSnapshotIdentifier</span><span style="color:#f92672">:</span><span style="color:#a6e22e">snap</span>}).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
    });
  }

  <span style="color:#a6e22e">deleteInstanceSnapshot</span>(<span style="color:#a6e22e">snap</span>){
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rds</span>.<span style="color:#a6e22e">deleteDBSnapshot</span>({<span style="color:#a6e22e">DBSnapshotIdentifier</span><span style="color:#f92672">:</span><span style="color:#a6e22e">snap</span>}).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">data</span>)=&gt;{
    });
  }

  <span style="color:#a6e22e">renameSnapshot</span>(<span style="color:#a6e22e">snapName</span>){
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#e6db74">&#39;arn:&#39;</span>)){
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#34;snapshot:rds&#34;</span>);
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tmpName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">substring</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">length</span>)
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tmpName</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;snapshot:&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#34;rds:&#34;</span>, <span style="color:#e6db74">&#34;manual-&#34;</span>);
    }<span style="color:#66d9ef">else</span>{
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">snapName</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#34;rds:&#34;</span>, <span style="color:#e6db74">&#34;manual-&#34;</span>)
    }
  }

}


<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">RDSFunc</span>
}
</code></pre></div><p>First detail that&rsquo;s pops-up is that cluster and instances are treat by different call on SDK following by its snapshots</p>
<blockquote>
<blockquote>
<p>describeDBClusters
describeDBInstances
describeDBClusterSnapshots
describeDBSnapshots</p>
</blockquote>
</blockquote>
<p>Another detail is to search snapshots you have to know the resource&rsquo;s names (cluster or instance), because of that all lambdas perform a query to list all resources for both copy or delete.</p>
<p>Below we have a list of all daily cluster backups, checked by date from a function that will remove days from today and right after will call copy function. As all calls are asynchronous after lambda execution you can follow the copy through the console, depend of the database size of course. On the second piece all this process is repeated to instances.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cluster</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClusters</span>();

    <span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">cluster</span>)=&gt;{
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClustersAutomatedSnapshot</span>(<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">DBClusterIdentifier</span>)
        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snaps</span>){
          <span style="color:#a6e22e">snaps</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">snap</span>)=&gt;{
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">minusDaysFromToday</span>(<span style="color:#a6e22e">daysBefore</span>);
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snapshotDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">removeTimeFromDate</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">SnapshotCreateTime</span>);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">snapshotDate</span>) {
                <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">copyClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">DBClusterSnapshotIdentifier</span>)
                <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">copy</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; Rds cluster snapshot cloned&#34;</span>)
            }
        })
        }        
    })

<span style="color:#75715e">//RDS Instance
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">instances</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeInstances</span>();
    <span style="color:#a6e22e">instances</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">instance</span>)=&gt;{
      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeInstanceAutomatedSnapshot</span>(<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">DBInstanceIdentifier</span>)
      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snaps</span>){
        <span style="color:#a6e22e">snaps</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">snap</span>)=&gt;{
          <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">minusDaysFromToday</span>(<span style="color:#a6e22e">daysBefore</span>);
          <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snapshotDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">removeTimeFromDate</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">SnapshotCreateTime</span>);
          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">snapshotDate</span>) {
              <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">copyInstanceSnapshot</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">DBSnapshotIdentifier</span>)
              <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">copy</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; Rds instance snapshot cloned&#34;</span>)
          }
        })
      }      
    })
</code></pre></div><p>Delete follow the same structure but instead of copy function you have delete</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cluster</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClusters</span>();

    <span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">cluster</span>)=&gt;{
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClustersManualSnapshot</span>(<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">DBClusterIdentifier</span>)
        
        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snaps</span>){
          <span style="color:#a6e22e">snaps</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">snap</span>)=&gt;{
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">minusDaysFromToday</span>(<span style="color:#a6e22e">daysBefore</span>);
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snapshotDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">removeTimeFromDate</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">SnapshotCreateTime</span>);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">snapshotDate</span>) {
                <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">deleteClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">DBClusterSnapshotIdentifier</span>)
                <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">copy</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; Rds cluster snapshot deleted&#34;</span>)
            }
        })
        }        
    })
</code></pre></div><p>On the function that copy to another region comes a interesting detail, the search has to be realized from the original region but the copy will be executed from the destiny region and informed the original region. Another detail here is that copy function will reference the snapshot by ARN instead the name.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cluster</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClusters</span>();

<span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">length</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snaps</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFunc</span>.<span style="color:#a6e22e">describeClustersAutomatedSnapshot</span>(<span style="color:#a6e22e">cluster</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">DBClusterIdentifier</span>)
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">snaps</span>){
        <span style="color:#a6e22e">snaps</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">snap</span>)=&gt;{
            <span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">update</span>({
                <span style="color:#a6e22e">region</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">copyRegion</span>
            })
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rdsFuncOtherRegion</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RDSFunc</span>(<span style="color:#a6e22e">AWS</span>)
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">minusDaysFromToday</span>(<span style="color:#a6e22e">daysBefore</span>);
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">snapshotDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dateFunc</span>.<span style="color:#a6e22e">removeTimeFromDate</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">SnapshotCreateTime</span>);
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyDate</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">snapshotDate</span>) {
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">copy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">rdsFuncOtherRegion</span>.<span style="color:#a6e22e">copyClusterSnapshot</span>(<span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">DBClusterSnapshotArn</span>,<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">mainRegion</span>)
            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">copy</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34; Rds cluster snapshot cloned&#34;</span>)
            }
        })
     }        
}
</code></pre></div><p>Delete function is the same but one more time just replacing copy for delete</p>
<p>If you look inside the function all variables comes from environment variables that were declared on the mail file  <code>serverless.yml</code> , this file is used by the framework. Below we inform the provider, the region where we will deploy you local aws profile and an IAM with RDS access (you can change for one more restrict one) and the variables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">provider</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">aws</span>
  <span style="color:#f92672">runtime</span>: <span style="color:#ae81ff">nodejs10.x</span>
  <span style="color:#f92672">region</span>: <span style="color:#ae81ff">us-west-2</span>
  <span style="color:#f92672">profile</span>: <span style="color:#ae81ff">&lt;YOUR-AWS-PROFILE&gt;</span>
  <span style="color:#f92672">iamManagedPolicies</span>:
    - <span style="color:#e6db74">&#34;arn:aws:iam::aws:policy/AmazonRDSFullAccess&#34;</span>
  <span style="color:#f92672">environment</span>:
    <span style="color:#f92672">daysBefore</span>: <span style="color:#ae81ff">30</span>
    <span style="color:#f92672">keepDays</span>: <span style="color:#ae81ff">6</span>
    <span style="color:#f92672">keepLongDays</span>: <span style="color:#ae81ff">365</span>
    <span style="color:#f92672">mainRegion</span>: <span style="color:#ae81ff">us-west-2</span>
    <span style="color:#f92672">copyRegion</span>: <span style="color:#ae81ff">us-east-2</span>
</code></pre></div><p><strong>daysBefore:</strong> <em>is about the amount of days on the snapshot research to turn it to manual, you can put 0 to get today but remember  that the snapshots are incremental depend of the time you can get an incomplete one.</em>
<strong>keepDays &amp; keepLongDays:</strong> <em>are related to how many days snapshots have to be kept respectively in another region and in the same region.</em></p>
<p><strong>mainRegion &amp; copyRegion:</strong> <em>the last two are related to the RDS region and the disaster recovery region</em></p>
<p>The packaging can be customized in that case I just use it to exclude some files</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">package</span>:
  <span style="color:#f92672">exclude</span>:
    - <span style="color:#ae81ff">README.md</span>
    - <span style="color:#ae81ff">.gitignore</span>
    - <span style="color:#ae81ff">.vscode</span>
    - <span style="color:#ae81ff">node_modules</span>
    - <span style="color:#ae81ff">__test__</span>
</code></pre></div><p>Below we finally have the function declaration in this order name, file + function name, timeout and a event trigger in our case is a cron schedule . I prefer this approach of deploy all function at once but it&rsquo;s possible deploy one function at the time, you will see right below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">functions</span>:
  <span style="color:#f92672">manual-backup</span>:
    <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">rds-clone-snap.main</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">events</span>:
      - <span style="color:#f92672">schedule</span>: <span style="color:#ae81ff">cron(0 10 1/1 * ? *)</span>
  <span style="color:#f92672">manual-backup-other-region</span>:
    <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">rds-clone-snap-region.main</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">events</span>:
      - <span style="color:#f92672">schedule</span>: <span style="color:#ae81ff">cron(0 10 1/1 * ? *)</span>
  <span style="color:#f92672">delete-backup</span>:
    <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">rds-del-snap.main</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">events</span>:
      - <span style="color:#f92672">schedule</span>: <span style="color:#ae81ff">cron(0 10 1/1 * ? *)</span>
  <span style="color:#f92672">delete-backup-other-region</span>:
    <span style="color:#f92672">handler</span>: <span style="color:#ae81ff">rds-del-snap-region.main</span>
    <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">events</span>:
      - <span style="color:#f92672">schedule</span>: <span style="color:#ae81ff">cron(0 10 1/1 * ? *)</span>
</code></pre></div><p>Ok, everything is set now is the time to send all to the cloud. This code below is all you need</p>
<p><code>serverless deploy</code></p>
<p>Or function by function</p>
<p><code>serverless deploy function --function manual-backup</code></p>
<p>To remove</p>
<p><code>serverless remove</code></p>
<p>Here we can say that we can sleep more peacefully knowing that our RDS are protected from possible failures. The basics of snapshots and availability in other regions are covered here, it is obvious that a disaster recovery solution for your environment will be more complete and will involve more technologies and other forms of automation.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/documenting-databases-with-schemaspy/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Documenting Databases With Schemaspy</span>
    </a>
    
    
    <a href="/posts/managing-github-terraform/" class="navigation-next">
      <span class="navigation-tittle">Managing your github account with terraform</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
